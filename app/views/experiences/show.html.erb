<% content_for :meta_tag do%>
  <%= Handcache.get_and_set("#{params.values.sort.to_s}-#{@experience.updated_at.to_s(:fulltime)}") do
    title "#{truncate_u(Sanitize.clean(@experience.content), 10)}" 
    description "#{truncate_u(Sanitize.clean(@experience.content), 100)}" 
    keywords @experience.tag_list 
    display_meta_tags :site => t('site.name') 
  end %>  
<% end %>

<% content_for :sider do %>
  <%= Handcache.get_and_set("#{params.values.sort.to_s}-#{I18n.locale}-sider", :expires_in => 60 ) do
    render :partial => 'show_sider', :locals => {:experiences => @related_exps}
  end %>  
<% end %>

<%= facebook_like %>
<%= share_button %>
<div id='exp_show_main'>
  <p class='exp_author'>
  <%= link_to t("exp.back_to_user", :name => @experience.user.nickname),  @current_goal ?  user_exps_path(:user_id => @experience.user, :goal_id => @current_goal) : user_home_path(@experience.user.username) %>
  </p>
  <div id='exp_show_content'>
    <div>
      <span id='exp_show_time'>
        <%= @experience.start_at.to_s(:date)%>
        <%=h "~ #{@experience.end_at.to_s(:date)}" if @experience.end_at %>
        <%= "(#{t'exp.private'})" if !@experience.public %>
      </span>

      <% if can? :update, @experience %>
        <span class='exp_function'>
          <%= link_to t('action.edit'), edit_experience_path(@experience) %>
        </span>
      <% end %>
      <span class='exp_function'>
        <% if can? :destroy, @experience %>
          <%= link_to t('action.destroy'), @experience, :confirm => t('action.confirm'), :method => :delete %>
        </span>
      <% end %>
    </div>

    <% if @experience.goal %>
      <p class='exp_category'>
      <strong><%= t'exp.belong_goal'%>:</strong>
        <%= link_to @experience.goal.title, @experience.goal%>
      </p>
    <% end %>

    <% params_hash = @current_goal ? {:goal_id => @current_goal.to_param} : {}%>
    <p class='exp-content'>
      <%= @experience.content %>
    </p>
    <p class='function'>
      <% unless @experience.first? %>
        <% if can? :show, @experience.prev_item(current_user, @current_goal.try(:id)) %>
          <%= link_to t('exp.prev'),  experience_path(@experience.prev_item(current_user, @current_goal.try(:id)), params_hash) if @experience.prev_item(current_user, @current_goal.try(:id))%>
        <% end %>
      <% end %>
      <% unless @experience.last? %>
        <% if can? :show, @experience.next_item(current_user, @current_goal.try(:id)) %>
          <%= link_to t('exp.next'),  experience_path(@experience.next_item(current_user, @current_goal.try(:id)), params_hash) if @experience.next_item(current_user, @current_goal.try(:id))%>
        <% end %>
      <% end %>
    </p>
    <p>
    <strong><%= t'exp.tags' %>: </strong>
      <span class='tags_func'>
        <% tag_link @experience %>
      </span>
      <div class='cheer_function'>
        <% if @experience.votes_for > 0%>
          <strong class='anchor'> <%= link_to @experience.likes_count, experience_votes_url(@experience) %> <%= t'exp.guys_like'%></strong>
        <% end %>

        <% form_for @vote do |f| %>
          <%= hidden_field_tag :voteable_type, @vote.voteable_type %>
          <%= hidden_field_tag :exp_id, @experience.id%>
          <%= hidden_field_tag :vote, 1 %>
          <%= f.submit t('action.like') %>
        <% end %>

      </div>
      <div class='clear'></div>

    </p>
    <%#= EXP_TYPE[@experience.exp_type] if @experience.exp_type %>
    <%#= @experience.location_list %>

  </div>
  <hr >
  <%= render :partial => 'comments/form' %>

  <h3><%= t'comment.label' %></h3>
  <div class='commentlist'>
    <% @comments.each do |c| %>
      <div class='comment'>
        <h3><span class='exp_author'><%= link_to c.user.nickname, user_home_path(c.user.username) %></span> <%= t'comment.say'%>...</h3>
        <div><%= Sanitize.clean(c.comment) %></div>
      </div>
    <% end %>
  </div>


</div>
